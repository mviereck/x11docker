#! /bin/bash
#########################################
# GUI for x11docker 
# Published under MIT licence
# Uses 'kaptain' to provide a GUI
# https://github.com/mviereck/x11docker
#########################################

error() {
  echo $1 >&2
  command -v xmessage >/dev/null && {
    xmessage -default okay "$1"
    :
  } || { 
    command -v zenity >/dev/null && {
      zenity --error --ellipsize --text="$1"
      :
    }
  } || notify-send "$1"
  exit 1
}
warning() {
  echo "x11docker-gui WARNING: $*" >&2
  echo "">&2
}

export PATH="$PATH:/usr/local/bin" # can miss if executed as root

# Try to find x11docker
X11docker_exe="${0%-gui}"                                            # look at path of current x11docker-gui
[ ! -f "$X11docker_exe" ] && X11docker_exe="$(command -v x11docker)" # look whether x11docker is in $PATH
[ ! -f "$X11docker_exe" ] && error "x11docker not found"
Version="$($X11docker_exe --version)"

# check logged-in user
Lognameuser="$(logname 2>/dev/null)"
[ -z "$Lognameuser" ] && warning "Your terminal seems to be not POSIX compliant.
  Command 'logname' does not return a value.
  Consider to use another terminal emulator."
[ -z "$Lognameuser" ] && [ -n "$SUDO_USER" ]  && Lognameuser="$SUDO_USER"  && warning "Will assume \$SUDO_USER = $SUDO_USER as host user."
[ -z "$Lognameuser" ] && [ -n "$PKEXEC_UID" ] && Lognameuser="$PKEXEC_UID" && warning "Will assume user with uid \$PKEXEC_UID = $PKEXEC_UID as host user."
[ -z "$Lognameuser" ] &&                         Lognameuser="$(id -un)"   && warning "Will assume \$(id -un) = $(id -un) as host user."
Lognameuserhome="$(getent passwd $Lognameuser | cut -d: -f6)"

CONTAINERUSER="$Lognameuser"
CONTAINERUSERHOME="$Lognameuserhome"

#####################
# Preset some options you may want to be set as default
#

IMAGELIST='"",
"x11docker/xfce ",
"x11docker/lxde ",
"x11docker/lxqt ",
"x11docker/mate ",
"x11docker/fluxbox ",
"x11docker/fvwm ",
"x11docker/lumina ",
"x11docker/trinity ",
"x11docker/plasma ",
"x11docker/enlightenment ",
"x11docker/lxde-wine ",
"x11docker/xfce-wine-playonlinux ",
"x11docker/cde \ \" # (needs --hostnet)",
"x11docker/deepin \ \" # (needs --systemd)",
"x11docker/cinnamon \ \" # (needs --dbus-system or --systemd)",
"x11docker/xwayland \ \" # (needs --wayland and --gpu)"
'

MYWM="auto"                                          # preferred host window manager
DOCKEROPTIONS=""                                     # additional docker options
# Checkboxes: "!" disables option, "" enables it
SHAREHOMEFOLDER="!"
CLIPBOARD="!"
PULSEAUDIO="!"
GPU="!"
DESKTOP="!"
#####################

## needed for github screenshots only
#CONTAINERUSER="\\\$USER"
#CONTAINERUSERHOME="/home/\\\$USER"

# check list of available window managers
Wm_all="$($X11docker_exe --wmlist)"
for Wm in $Wm_all ; do
  command -v "$Wm" >/dev/null && {
    grep -q "$Wm" <<< "$HOSTWM" || HOSTWM="$HOSTWM\"$Wm\","
  }
done

HOSTWM="$HOSTWM\"\",\"auto\",\"none\""
[ -n "$MYWM" ] && ! echo "$HOSTWM" | grep -q "$MYWM" && HOSTWM="\"$MYWM\",$HOSTWM"

# check sound cards for ALSA
while read Line; do
  ALSALIST="\"$Line\",$ALSALIST"
done < <(cat /proc/asound/cards | grep ':' | cut -d[ -f2 | cut -d] -f1)
ALSALIST="$ALSALIST\"\""

# if docker can run without password prompt, create list of available named images
sudo -n echo 2>/dev/null && Sudo="sudo -n" || Sudo=""
while read -r Image ; do
    Image="${Image%:<none>}"
    IMAGELIST="$IMAGELIST,\"$Image \""
done < <($Sudo docker images --format "{{.Repository}}:{{.Tag}}" | sort)

Hostlangland=$(echo $LANG | cut -d. -f1)
Langcombo="\"$Hostlangland\""
for Line in $(echo "aa_DJ aa_ER aa_ET af_ZA ak_GH am_ET an_ES anp_IN 
ar_AE ar_BH ar_DZ ar_EG ar_IN ar_IQ ar_JO ar_KW ar_LB ar_LY ar_MA ar_OM ar_QA ar_SA ar_SD ar_SS ar_SY ar_TN ar_YE as_IN ast_ES ayc_PE az_AZ
be_BY bem_ZM ber_DZ ber_MA bg_BG bhb_IN bho_IN bn_BD bn_IN bo_CN bo_IN br_FR brx_IN bs_BA byn_ER C 
ca_AD ca_ES ca_FR ca_IT ce_RU chr_US cmn_TW crh_UA csb_PL cs_CZ cv_RU cy_GB da_DK de_AT de_BE de_CH de_DE de_IT de_LI de_LU doi_IN dv_MV dz_BT 
el_CY el_GR en_AG en_AU en_BW en_CA en_DK en_GB en_HK en_IE en_IL en_IN en_NG en_NZ en_PH en_SG en_US en_ZA en_ZM en_ZW eo 
es_AR es_BO es_CL es_CO es_CR es_CU es_DO es_EC es_ES es_GT es_HN es_MX es_NI es_PA es_PE es_PR es_PY es_SV es_US es_UY es_VE et_EE eu_ES eu_FR 
fa_IR ff_SN fi_FI fil_PH fo_FO fr_BE fr_CA fr_CH fr_FR fr_LU fur_IT fy_DE fy_NL ga_IE gd_GB gez_ER gez_ET gl_ES gu_IN gv_GB 
hak_TW ha_NG he_IL hi_IN hne_IN hr_HR hsb_DE ht_HT hu_HU hy_AM ia_FR id_ID ig_NG ik_CA is_IS it_CH it_IT iu_CA 
ja_JP ka_GE kk_KZ kl_GL km_KH kn_IN kok_IN ko_KR ks_IN ku_TR kw_GB ky_KG lb_LU lg_UG li_BE lij_IT li_NL ln_CD lo_LA lt_LT lv_LV lzh_TW 
mag_IN mai_IN mg_MG mhr_RU mi_NZ mk_MK ml_IN mni_IN mn_MN mr_IN ms_MY mt_MT my_MM 
nan_TW nb_NO nds_DE nds_NL ne_NP nhn_MX niu_NU niu_NZ nl_AW nl_BE nl_NL nn_NO nr_ZA nso_ZA 
oc_FR om_ET om_KE or_IN os_RU pa_IN pap_AW pap_CW pa_PK pl_PL POSIX ps_AF pt_BR pt_PT quz_PE raj_IN ro_RO ru_RU ru_UA rw_RW 
sa_IN sat_IN sc_IT sd_IN se_NO sgs_LT shs_CA sid_ET si_LK sk_SK sl_SI so_DJ so_ET so_KE so_SO sq_AL sq_MK sr_ME sr_RS ss_ZA st_ZA sv_FI sv_SE sw_KE sw_TZ szl_PL 
ta_IN ta_LK tcy_IN te_IN tg_TJ the_NP th_TH ti_ER ti_ET tig_ER tk_TM tl_PH tn_ZA tr_CY tr_TR ts_ZA tt_RU 
ug_CN uk_UA unm_US ur_IN ur_PK uz_UZ ve_ZA vi_VN wa_BE wae_CH wal_ET wo_SN xh_ZA yi_US yo_NG yue_HK zh_CN zh_HK zh_SG zh_TW zu_ZA")
do Langcombo="$Langcombo,\"$Line\""; done

Keymaps="$(sed '/^! layout$/,/^ *$/!d ; //d' /usr/share/X11/xkb/rules/base.lst | awk '{print $1}' | sort)"
Hostkeymap="$(setxkbmap -query | grep layout | rev | cut -d' ' -f1 | rev)"
Keymapscombo=\"$Hostkeymap\"
Keymapscombo=${Keymapscombo:-\"\"}
for Line in $Keymaps; do Keymapscombo="$Keymapscombo,\"$Line\"" ; done


# Look for icon
[ -e /usr/share/icons/hicolor/64x64/apps/x11docker.png ]       && X11docker_icon=/usr/share/icons/hicolor/64x64/apps/x11docker.png
[ -e /usr/local/share/icons/hicolor/64x64/apps/x11docker.png ] && X11docker_icon=/usr/local/share/icons/hicolor/64x64/apps/x11docker.png

Kaptain_grammar='#! /usr/bin/kaptain
start "Run GUI applications in docker images - x11docker '$Version'"  -> options buttons;
  options:beside              -> frameleft frameright;
    frameleft                 -> choose_image_framed choose_xserver_framed appeareance_framed verbosity_framed;
    frameright                -> choose_options stddevelline @fill;
    
  choose_image_framed:framed -> choose_image;
  choose_image "Choose docker image"                                                        -> logo_imageorexe dockerimage;
    logo_imageorexe:beside                                                                  -> @icon("'$X11docker_icon'") imageorexe ;
      imageorexe                                                                            -> image | exe | xonly;
        image:beside     "Run docker image in segregated X server"                          -> "-- " security_dialog;
        exe              "--exe: Start host application in another X server"                -> "--exe -- ";
        xonly            "--xonly: Only create new empty X server"                          -> "--xonly -- "; 
    dockerimage          "docker image [and command] to run:"                               -> @combow('$IMAGELIST');
  
  choose_xserver_framed:framed -> choose_xserver;
  choose_xserver "Choose X server" -> xserverbla xservercombo desktop gpu wm wayland;
    xserverbla:beside -> @fill xinfobutton xdependenciesbutton ;
    xservercombo -> s/(:.*$)/ / @combo(
        ": Automatically choose X server (regards --desktop, --gpu and --wayland)",
        "--xpra:             Show container application windows on your main desktop",
        "--xephyr:           Show container desktop in a window on your main desktop",
        "--xpra-xwayland:    Like --xpra (allows --gpu)",
        "--weston-xwayland:  Like --xephyr (allows --gpu)",
        "--hostdisplay:      Share host X display '$DISPLAY' (Quite bad container isolation!)",
        "--xorg:             Core Xorg server. (Switch with <CTRL><ALT><F1>...<F12>)",
        "--nxagent:          Like --xpra; with --desktop like --xephyr. Experimental.",
        "--xwayland:         Core Xwayland. (Needs running Wayland on host).",
        "--xdummy:           Invisible X server Xdummy",
        "--xvfb:             Invisible X server Xvfb",
        "--kwin-xwayland:    Like --weston-xwayland, but using kwin_wayland",
        "--kwin:             Wayland in KWin without X",
        "--weston:           Wayland in Weston without X",
        "--hostwayland:      Share host Wayland display without X",
        "--nothing:          No X and no Wayland"
      );
    gpu           "--gpu: Hardware acceleration for OpenGL (degrades container isolation)"  -> "--gpu "                                     | '$GPU' "";
    wm :beside    "--wm: Host window manager to use"                                        -> "--wm=\"" @combow('$HOSTWM')="'$MYWM'" "\" " | ! "" ;
    desktop       "--desktop: Image contains a desktop environment"                         -> "--desktop "                                 | '$DESKTOP' "" ;
    wayland     "--wayland: Create Wayland environment"                                   -> "--wayland "       | ! "" ;
        
    appeareance_framed:framed -> sizefullscreen ;
    sizefullscreen " Appearance of new X server" -> sizefullscreenline scale rotate dpi outputcount;
      sizefullscreenline:beside -> size xfishtank fullscreen;
        size:beside       "--size: virtual screen size"                                     -> "--size \""         @combow("320x240","640x480","800x600","1024x768","1280x800","1280x1024","1400x1050","1680x1200","1920x1080")="800x600"  "\" "| !"" ;
        fullscreen        "--fullscreen"                                                    -> "--fullscreen "     | ! "" ;
        xfishtank         "--xfishtank"                                                     -> "--xfishtank "      | ! "" ;
      scale:beside        "--scale: zoom factor (Xpra, Xorg: all, Weston: full integer only)"  -> "--scale=\""     @combow("0.25","0.5","0.75","0.9","1","1.25","1.5","2","2.5","3")="1.5"                    "\" "  | ! "" ;
      rotate:beside       "--rotate: rotation and mirroring (Xorg and Weston only)"         -> "--rotate=\""       @combo("0","90","180","270","flipped","flipped-90","flipped-180","flipped-270")="180" "\" "  | ! "" ;
      dpi:beside          "--dpi: screen density / dots per inch (influences font size)"    -> "--dpi=\""          @combow("36","48","60","72","84","96","120","150","256","300")="96"                   "\" "  | ! "" ;
      outputcount:beside  "--output-count: multiple displays (Weston, KWin, Xephyr)"        -> "--output-count=\"" @combow("1","2","3","4")="2"                                                          "\" "  | ! "" ;
      
    verbosity_framed:framed -> verbosity ;
    verbosity "Verbosity" -> verbosesilentline stdoutstderrline;
      verbosesilentline:beside -> verbose silent;
        verbose             "--verbose: Be verbose"                                         -> "--verbose "       | ! "" ;
        silent              "--silent: Be silent"                                           -> "--silent "        | ! "" ;
      stdoutstderrline:beside -> stdout stderr ;
        stdout           "--stdout: Show stdout of container"                               -> "--stdout "        | ! "" ;
        stderr           "--stderr: Show stderr of container"                                                        -> "--stderr "        | ! "" ;
    
    choose_options:framed -> choose_options_normal choose_options_hostfolders choose_options_advanced;
    choose_options_normal "Sound, clipboard and language"  -> clipboard alsaline pulseaudio lang ;
      clipboard           "--clipboard: Enable clipboard sharing (image clips: xpra only)"  -> "--clipboard "     | '$CLIPBOARD' "";
      pulseaudio          "--pulseaudio: Sound with pulseaudio (needs pulseaudio in image, too)"            -> "--pulseaudio "    | '$PULSEAUDIO' "";
      alsaline:beside -> alsa alsacard;
        alsa              "--alsa: Sound with ALSA"                                         -> "--alsa "          | ! "" ;
        alsacard:beside   "--env ALSA_CARD="                                                -> "--env ALSA_CARD=\"" @combow('$ALSALIST') "\" " | ! "";
    lang:beside           "--lang: Language utf8 locale setting, create it if missing"      -> "--lang=\""        @combow('$Langcombo')="'$Hostlangland'" "\" " | ! "" ;
      
    choose_options_hostfolders "Host directories to share" -> home homedir sharedir1 sharedir2;
      home                "--home: Share a host folder in '$CONTAINERUSERHOME'/x11docker \n
                           as '$CONTAINERUSERHOME' in container."                           -> "--home "          | '$SHAREHOMEFOLDER' "";  
      homedir             "--homedir: Host directory to use as container home: "            -> "--homedir=\""     @directory=""  "\" " | ! "" ;
      sharedir1:beside    "--sharedir: Share host folder:"                                  -> "--sharedir=\""    @directory=""  "\" " | ! "" ;
      sharedir2:beside    "--sharedir: Share host folder:"                                  -> "--sharedir=\""    @directory=""  "\" " | ! "" ;

    choose_options_advanced "Advanced options"-> sudouser noentrypoint nointernet initsystem dbusdaemon dbus pw;
      sudouser           "--sudouser: Allow su and sudo in container. Password: x11docker\n
                          Severe reduction of container security!"                          -> "--sudouser "      | ! "" ;
      noentrypoint        "--no-entrypoint: Disable ENTRYPOINT in image"                    -> "--no-entrypoint " | ! "" ;
      nointernet          "--no-internet: Disable internet access for container"            -> "--no-internet "   | ! "" ;
      initsystem:beside   " Run init system in container (default: --tini)"                 -> @combo( "--tini","--systemd ","--sysvinit ","--runit ","--openrc ","--no-init")="--systemd "   | ! "" ;
      dbusdaemon          "--dbus-system: Run dbus system daemon in container (includes --dbus)"  -> "--dbus-system "   | ! "" ;
      dbus                "--dbus: Run dbus user session in container"                      -> "--dbus "          | ! "" ;
      pw:beside           "--pw: password prompt frontend"                                  -> "--pw=\"" @combo("su","sudo","gksu","gksudo","lxsu","lxsudo","kdesu","kdesudo","beesu","pkexec","none")="sudo" "\" " | ! "" ;
                   
stddevelline:beside -> develdialog;
  develdialog:dialog "Developer options" -> developeroptions @close=" close";
    developeroptions:beside -> develleft develright;
      develleft:framed -> devauth devxconfig devmisc;
      develright:framed ->  devenvironment devuser devcaps devrun;
        develcollect -> devenvironment devauth devxconfig devmisc devuser devcaps;
    devuser "User settings" -> user hostuser groupadd;
      user:beside      "--user: Container user (name or uid)\n 
                        (default: same as host user)\n
                        (a gid can be specified with user:gid)"                             -> "--user=\""       @string="'$CONTAINERUSER'" "\" " | ! "" ;
      hostuser:beside    "--hostuser: run x11docker as user \n
                          different from \$(logname)='$CONTAINERUSER':\n
                          (x11docker must be started as root)"                              -> "--hostuser=\""   @string=""  "\" " | ! "" ;
      groupadd:beside    "--group-add: Additional groups for container user: "              -> "--group-add=\""  @string=""  "\" " | ! "" ;
    devmisc  "Miscellaneous" -> ps cachedir runfromhost runasroot;
      ps                 "--ps: Keep created container and cache files"                     -> "--ps "            | ! "" ;
      cachedir:beside    "--cachedir: Host cache folder: "                                  -> "--cachedir=\""   @directory=""  "\" " | ! "" ;
      runfromhost        "--runfromhost: Run host command on new X server. Use sh syntax:"  -> "--runfromhost=\"" @string="/usr/bin/launchy &" "\" " | ! "" ;
      runasroot          "--runasroot: Run command as root in container. Use sh syntax:"    -> "--runasroot=\""   @string="" "\" " | ! "" ;
    devoutput "Verbose output" -> debug;
      debug              "--debug: Show some additional debug output"                       -> "--debug "         | ! "" ;
    devauth "X authentication" -> untrusted trusted xhost noauth noxhost; 
      untrusted          "--untrusted: Create untrusted cookies restricting X access. \n 
                           Default for --hostdisplay."                                      -> "--untrusted "     | ! "" ;
      trusted            "--trusted: Trusted cookies for --hostdisplay. Default for --gpu." -> "--trusted "       | ! "" ;
      xhost:beside       "--xhost: see \"man xhost\". Use with care"                        -> "--xhost=\""      @string="+SI:localuser:'$CONTAINERUSER'" "\" "     | ! "" ;
      noauth             "--no-auth: Disable cookie authentication on new X server."        -> "--no-auth "       | ! "" ;
      noxhost            "--no-xhost: Disable any \"xhost +...\" access to host X server"   -> "--no-xhost "      | ! "" ;
    devenvironment "Environment" -> setenvdialog showenv showid workdir;
      showenv            "--showenv: Output of environment variables of new X server \n
                          on stdout. Default for --xdummy, --xvfb and --xonly."             -> "--showenv "       | ! "" ;
      showid             "--showid: Output of container ID on stdout."                      -> "--showid "        | ! "" ;
      sharewayland       "--sharewayland: Share wayland socket and \$WAYLAND_DISPLAY.\n 
                          Default for --wayland, --weston, --kwin and --hostwayland."       -> "--sharewayland "  | ! "" ;
      waylandenv         "--waylandenv: Set wayland toolkit environment variables.\n
                          Default for --wayland, needed for QT5 in Wayland."                -> "--waylandenv "    | ! "" ; 
      workdir:beside     "--workdir: Working directory: "                                   -> "--workdir=\""    @string=""      "\" " | ! "";
    devxconfig "X and Wayland configuration" -> vt display xtest noxtest keymap westonini;
      vt :beside         "--vt: virtual terminal/tty to use: 
                          (--xorg, --xpra, --xdummy)"                                       -> "--vt=\""         @string="8"     "\" " | ! "";
      display :beside    "--display: display number to use (X and Wayland): "               -> "--display=\""    @string="1000"  "\" " | ! "";
      xtest              "--xtest: enable X extension XTEST. Default for --xdummy, --xvfb, --xpra" -> "--xtest "  | ! "";
      noxtest            "--no-xtest: disable X extension XTEST for --xdummy, --xvfb, --xpra" -> "--no-xtest "    | ! "";
      keymap:beside      "--keymap: XKB keyboard layout: (X and Wayland)"                   -> "--keymap \""     @combow('$Keymapscombo') "\" " | ! "";
      westonini          "--westonini: Custom weston.ini (see man weston.ini)"              -> "--westonini=\""  @infile="/usr/share/doc/weston/examples/weston.ini"      "\" " | ! "";
    devrun ->  setcapsdialog dockeroptions ;
      dockeroptions        "Custom options for \"docker run\" "                             ->  @string="'$DOCKEROPTIONS'" ;
    devcaps "Container capabilities and namespaces" -> capdefault sysadmin sharecgroup ipc net;
      capdefault         "--cap-default: Allow default container capabilities."             -> "--cap-default "   | ! "" ;
      sysadmin           "--sys-admin: add capability SYS_ADMIN. Needed for older systemd \n
                          versions like in debian 9 based images for --systemd."            -> "--sys-admin "     | ! "" ;
      sharecgroup        "--sharecgroup: Share /sys/fs/cgroup. \n
                          Default for --systemd. Needed for elogind in container."          -> "--sharecgroup "   | ! "" ;
      ipc                "--hostipc: Disable IPC namespacing. Allows MIT-SHM extension. \n
                         Shares host interprocess communication and shared memory. "        -> "--hostipc "       | ! "" ;
      net                "--hostnet: Disable network namespacing. \n
                         Shares host network stack including dbus."                         -> "--hostnet "       | ! "" ;
      
    setenvdialog:beside "--env: Set custom environment variables: " -> envdialog ;
      envdialog:dialog "Environment variables" -> envdialogwaylandinfo envXDG envGTK envQT envQTegl envClutter envSDL envElementary1 envElementary2 envEvas 
                                                  envdialogothers envKWin envQT4shm envQT5deco envBWbackend envBWdisplay envLANG envSHELL
                                                  envCustom1 envCustom2 envCustom3 envCustom4 @close="close";
        envdialogwaylandinfo      "This environment variables summon toolkits to use Wayland instead of X11" -> "";
        envXDG:beside                       -> "--env=\""  @string="XDG_SESSION_TYPE=wayland"               "\" " | ! "" ;
        envGTK:beside         "GTK3"        -> "--env=\""  @string="GDK_BACKEND=wayland"                    "\" " | ! "" ;
        envQT:beside          "QT5"         -> "--env=\""  @string="QT_QPA_PLATFORM=wayland"                "\" " | ! "" ;
        envQTegl:beside       "QT5"         -> "--env=\""  @string="QT_QPA_PLATFORM=wayland-egl"            "\" " | ! "" ;
        envClutter:beside     "Clutter"     -> "--env=\""  @string="CLUTTER_BACKEND=wayland"                "\" " | ! "" ;
        envSDL:beside         "SDL"         -> "--env=\""  @string="SDL_VIDEODRIVER=wayland"                "\" " | ! "" ;
        envElementary1:beside "Elementary"  -> "--env=\""  @string="ELM_DISPLAY=wl"                         "\" " | ! "" ;
        envElementary2:beside "Elementary"  -> "--env=\""  @string="ELM_ACCEL=opengl"                       "\" " | ! "" ;
        envEvas:beside        "Ecore_Evas"  -> "--env=\""  @string="ECORE_EVAS_ENGINE=wayland_egl"          "\" " | ! "" ;
        envdialogothers:beside    "Other environment variable settings"  -> "";
        envKWin:beside        "KWin"        -> "--env=\""  @string="KWIN_COMPOSE=Q"                         "\" " | ! "" ;
        envQT4shm:beside      "QT4"         -> "--env=\""  @string="QT_X11_NO_MITSHM=1"                     "\" " | ! "" ;
        envQT5deco:beside     "QT5"         -> "--env=\""  @string="QT_WAYLAND_DISABLE_WINDOWDECORATION=1"  "\" " | ! "" ;
        envBWbackend:beside   "GTK3"        -> "--env=\""  @string="GDK_BACKEND=broadway"                   "\" " | ! "" ;
        envBWdisplay:beside   "GTK3"        -> "--env=\""  @string="BROADWAY_DISPLAY=:5"                    "\" " | ! "" ;
        envLANG:beside        "Language"    -> "--env=\""  @string="LANG='$LANG'"                           "\" " | ! "" ;
        envSHELL:beside       "User shell"  -> "--env=\""  @string="SHELL='$SHELL'"                         "\" " | ! "" ;
        envCustom1:beside     "Custom"      -> "--env=\""  @string=""                                       "\" " | ! "" ;
        envCustom2:beside     "Custom"      -> "--env=\""  @string=""                                       "\" " | ! "" ;
        envCustom3:beside     "Custom"      -> "--env=\""  @string=""                                       "\" " | ! "" ;
        envCustom4:beside     "Custom"      -> "--env=\""  @string=""                                       "\" " | ! "" ;
        
    setcapsdialog:beside "Add container capabilities:"                                ->  capsdialog ;
      capsdialog:dialog  "docker capabilities and privileges"  -> capsreference capstable @close="close";
        capsreference " Add container capabilities degrading container isolation if needed. Use with care.\n\n
                        x11docker disables all this capabilities per default with \"--cap-drop=ALL --security-opt=no-new-privileges\". \n\n
                        Left column (SETPCAP till SETFCAP) contains capabilities normally enabled by docker per default.\n
                        Middle and right column (SYS_MODULE till BLOCK_SUSPEND) contain capabilities disabled by docker per default.\n\n
                        See \"man capabilities\" and docker run reference: https://docs.docker.com/engine/reference/run/ " -> "" ;
                       
    capstable:framed:beside -> capsleft capsmiddle capsright;
      capsleft -> drop_1 drop_2 drop_3 drop_4 drop_5 drop_6 drop_7 drop_8 drop_9 drop_10 drop_11 drop_12 drop_13 drop_14 ;
        drop_1:beside  "--cap-add"  -> "--cap-add="   @string="SETPCAP"           " " | ! "" ;
        drop_2:beside  "--cap-add"  -> "--cap-add="   @string="MKNOD"             " " | ! "" ;
        drop_3:beside  "--cap-add"  -> "--cap-add="   @string="AUDIT_WRITE"       " " | ! "" ;
        drop_4:beside  "--cap-add"  -> "--cap-add="   @string="CHOWN"             " " | ! "" ;
        drop_5:beside  "--cap-add"  -> "--cap-add="   @string="NET_RAW"           " " | ! "" ;
        drop_6:beside  "--cap-add"  -> "--cap-add="   @string="DAC_OVERRIDE"      " " | ! "" ;
        drop_7:beside  "--cap-add"  -> "--cap-add="   @string="FOWNER"            " " | ! "" ;
        drop_8:beside  "--cap-add"  -> "--cap-add="   @string="FSETID"            " " | ! "" ;
        drop_9:beside  "--cap-add"  -> "--cap-add="   @string="KILL"              " " | ! "" ;
        drop_10:beside "--cap-add"  -> "--cap-add="   @string="SETGID"            " " | ! "" ;
        drop_11:beside "--cap-add"  -> "--cap-add="   @string="SETUID"            " " | ! "" ;
        drop_12:beside "--cap-add"  -> "--cap-add="   @string="NET_BIND_SERVICE"  " " | ! "" ;
        drop_13:beside "--cap-add"  -> "--cap-add="   @string="SYS_CHROOT"        " " | ! "" ;
        drop_14:beside "--cap-add"  -> "--cap-add="   @string="SETFCAP"           " " | ! "" ;
      capsmiddle -> add_1 add_2 add_3 add_4 add_5 add_6 add_7 add_8 add_9 add_10 add_11 add_12 add_13 add_14 ;
        add_1:beside   "--cap-add"  -> "--cap-add="   @string="SYS_MODULE"        " " | ! "" ;
        add_2:beside   "--cap-add"  -> "--cap-add="   @string="SYS_RAWIO"         " " | ! "" ;
        add_3:beside   "--cap-add"  -> "--cap-add="   @string="SYS_PACCT"         " " | ! "" ;
        add_4:beside   "--cap-add"  -> "--cap-add="   @string="SYS_ADMIN"         " " | ! "" ;
        add_5:beside   "--cap-add"  -> "--cap-add="   @string="SYS_NICE"          " " | ! "" ;
        add_6:beside   "--cap-add"  -> "--cap-add="   @string="SYS_RESOURCE"      " " | ! "" ;
        add_7:beside   "--cap-add"  -> "--cap-add="   @string="SYS_TIME"          " " | ! "" ;
        add_8:beside   "--cap-add"  -> "--cap-add="   @string="SYS_TTY_CONFIG"    " " | ! "" ;
        add_9:beside   "--cap-add"  -> "--cap-add="   @string="AUDIT_CONTROL"     " " | ! "" ;
        add_10:beside  "--cap-add"  -> "--cap-add="   @string="MAC_OVERRIDE"      " " | ! "" ;
        add_11:beside  "--cap-add"  -> "--cap-add="   @string="MAC_ADMIN"         " " | ! "" ;
        add_12:beside  "--cap-add"  -> "--cap-add="   @string="NET_ADMIN"         " " | ! "" ;
        add_13:beside  "--cap-add"  -> "--cap-add="   @string="SYSLOG"            " " | ! "" ;
        add_14:beside  "--cap-add"  -> "--cap-add="   @string="DAC_READ_SEARCH"   " " | ! "" ;
      capsright -> add_15 add_16 add_17 add_18 add_19 add_20 add_21 add_22 add_23 @fill device_1 device_2 device_3 device_4 @fill privileged;
        add_15:beside  "--cap-add"  -> "--cap-add="   @string="LINUX_IMMUTABLE"   " " | ! "" ;
        add_16:beside  "--cap-add"  -> "--cap-add="   @string="NED_BROADCAST"     " " | ! "" ;
        add_17:beside  "--cap-add"  -> "--cap-add="   @string="IPC_LOCK"          " " | ! "" ;
        add_18:beside  "--cap-add"  -> "--cap-add="   @string="IPC_OWNER"         " " | ! "" ;
        add_19:beside  "--cap-add"  -> "--cap-add="   @string="SYS_PTRACE"        " " | ! "" ;
        add_20:beside  "--cap-add"  -> "--cap-add="   @string="SYS_BOOT"          " " | ! "" ;
        add_21:beside  "--cap-add"  -> "--cap-add="   @string="LEASE"             " " | ! "" ;
        add_22:beside  "--cap-add"  -> "--cap-add="   @string="WAKE_ALARM"        " " | ! "" ;
        add_23:beside  "--cap-add"  -> "--cap-add="   @string="BLOCK_SUSPEND"     " " | ! "" ;
        device_1:beside"--device"   -> "--device="    @string=""                  " " | ! "" ;
        device_2:beside"--device"   -> "--device="    @string=""                  " " | ! "" ;
        device_3:beside"--device"   -> "--device="    @string=""                  " " | ! "" ;
        device_4:beside"--device"   -> "--device="    @string=""                  " " | ! "" ;
        privileged     "--privileged" -> "--privileged "                              | ! "" ;

    
  xinfobutton:dialog "X server info" -> xinfo @close=" close";
    xinfo:beside -> xinfo_option xinfotext xinfo_gpu;
      xinfo_option -> xinfo_option_title        xinfo_option_auto 
                      xinfo_option_xpra         xinfo_option_xephyr 
                      xinfo_option_xpraxwayland xinfo_option_westonxwayland 
                      xinfo_option_hostdisplay  xinfo_option_xorg 
                      xinfo_option_nxagent
                      xinfo_option_xwayland     xinfo_option_xdummy
                      xinfo_option_kwinxwayland xinfo_option_kwin 
                      xinfo_option_weston       xinfo_option_wayland;
        xinfo_option_title ->           @text(" X server");
        xinfo_option_auto ->            @text(" --auto\n\n");
        xinfo_option_xpra ->            @text(" --xpra\n\n\n");
        xinfo_option_xephyr ->          @text(" --xephyr");
        xinfo_option_xorg ->            @text(" --xorg\n");
        xinfo_option_hostdisplay ->     @text(" --hostdisplay\n\n\n");
        xinfo_option_xpraxwayland ->    @text(" --xpra-xwayland\n\n");
        xinfo_option_westonxwayland ->  @text(" --weston-xwayland\n\n");
        xinfo_option_nxagent ->         @text(" --nxagent\n\n");
        xinfo_option_xwayland ->        @text(" --xwayland\n");
        xinfo_option_xdummy ->          @text(" --xdummy\n --xvfb\n");
        xinfo_option_kwinxwayland ->    @text(" --kwin-xwayland\n");
        xinfo_option_weston ->          @text(" --weston\n");
        xinfo_option_kwin ->            @text(" --kwin\n");
        xinfo_option_wayland ->         @text(" --hostwayland\n");
      xinfotext -> xinfo_title        xinfo_auto 
                   xinfo_xpra         xinfo_xephyr 
                   xinfo_xpraxwayland xinfo_westonxwayland 
                   xinfo_hostdisplay  xinfo_xorg 
                   xinfo_nxagent
                   xinfo_xwayland     xinfo_xdummy
                   xinfo_kwinxwayland xinfo_kwin
                   xinfo_weston       xinfo_wayland;
        xinfo_title ->          @text(" ");
        xinfo_auto ->           @text(" Chooses an X server depending on installed dependencies and on given or missing options --desktop, --gpu and --wayland.\n
                                        --desktop indicates a desktop environment in image (instead of a single application).");
        xinfo_xpra ->           @text(" Recommended to run single applications. Application window appears on host display. \n
                                        Best --clipboard support, picture clips are possible. Seamless scaling (0,5x, 1.5x, 3x ...) with option --scale is possible\n
                                        Along with option --desktop usefull for desktop environments, too (similar to --xephyr).");
        xinfo_xephyr ->         @text(" Recommended to run desktop environments. Desktop appears in a window on host display. Low overhead, very fast.");
        xinfo_xorg ->           @text(" Core X server. Switch between displays with keys [CTRL][ALT][F1]...[F12]. Runs ootb from console.");
        xinfo_hostdisplay ->    @text(" Share host display :0 instead of running second X server. Attention: Low security, quite bad container isolation!\n
                                        Please look at button [Security info]. Use with trusted images only. To reduce risks and to avoid bad RAM access, \n
                                        untrusted cookies restricting X access are used. (Some applications will not work in untrusted mode). Least overhead.\n");
        xinfo_xpraxwayland ->   @text(" Like --xpra, uses Xwayland in background. Additional to --xpra, GPU acceleration with option --gpu is possible.\n
                                        Along with option --desktop usefull for desktop environments, too (similar to --xephyr).");
        xinfo_westonxwayland -> @text(" Like --xephyr, Weston with Xwayland. Can run on X or Wayland in a window or on its own from console. \n
                                        GPU acceleration, scaling (2x, 3x, 4x ...) and display rotation (0°, 90°, 180°, 270°, flipped, flipped-90°, ...) are possible.");
        xinfo_nxagent ->        @text(" Like --xpra, but faster startup. (but no graphical clipboard and no scaling). Quite fast, low overhead.\n
                                        Along with option --desktop like --xephyr, but better resizeable. Toggle fullscreen in desktop mode with [CTRL][ALT][SHIFT][F].");
        xinfo_xwayland ->       @text(" Core Xwayland needs a Wayland environment to run in. Fullscreen display can be moved around with [META][LMB].\n");
        xinfo_xdummy:beside ->  @text(" Invisible X server for custom access. Output of environment variables on stdout. \n
                                        With --gpu a setup with Weston, Xwayland and xdotool is used (instead of Xdummy or Xvfb).") xinfo_xdummy_network;
        xinfo_weston ->         @text(" Weston without X to run pure Wayland applications. Runs in X, in Wayland or from console. Scaling and rotation is possible.");
        xinfo_kwinxwayland ->   @text(" Like --weston-xwayland, but using Kwin instead of Weston. Runs in X, in Wayland or from console.");
        xinfo_kwin ->           @text(" kwin_wayland without X to run pure Wayland applications. Runs in X, in Wayland or from console.");
        xinfo_wayland ->        @text(" Shares host wayland socket without X to run pure Wayland applications. Needs a running Wayland compositor.");
      xinfo_gpu ->    xinfo_gpu_title        xinfo_gpu_auto 
                      xinfo_gpu_xpra         xinfo_gpu_xephyr 
                      xinfo_gpu_xpraxwayland xinfo_gpu_westonxwayland 
                      xinfo_gpu_hostdisplay  xinfo_gpu_xorg 
                      xinfo_gpu_nxagent
                      xinfo_gpu_xwayland     xinfo_gpu_xdummy
                      xinfo_gpu_kwinxwayland xinfo_gpu_kwin
                      xinfo_gpu_weston       xinfo_gpu_wayland;
        xinfo_gpu_title ->           @text(" --gpu ");
        xinfo_gpu_auto ->            @text(" \n\n");
        xinfo_gpu_xpra ->            @text(" no\n\n\n");
        xinfo_gpu_xephyr ->          @text(" no\n");
        xinfo_gpu_xorg ->            @text(" yes\n");
        xinfo_gpu_hostdisplay ->     @text(" yes\n\n\n");
        xinfo_gpu_xpraxwayland ->    @text(" yes\n\n");
        xinfo_gpu_westonxwayland ->  @text(" yes\n\n");
        xinfo_gpu_nxagent ->         @text(" no\n\n");
        xinfo_gpu_xwayland ->        @text(" yes\n");
        xinfo_gpu_xdummy ->          @text(" yes\n\n");
        xinfo_gpu_weston ->          @text(" yes\n");
        xinfo_gpu_kwinxwayland ->    @text(" yes\n");
        xinfo_gpu_kwin ->            @text(" yes\n");
        xinfo_gpu_wayland ->         @text(" yes\n");
        
          xinfo_xdummy_network:dialog "Network setup example" -> @text(" Sample setup for HTML5 web application:\n
                                                                        \n
                                                                        \ \ read Xenv < <(x11docker --xdummy  x11docker/lxde pcmanfm)\n
                                                                        \ \ echo \$Xenv\n
                                                                        \ \ export \$Xenv\n
                                                                        \ \ xpra start \$DISPLAY --use-display --html=on --bind-tcp=localhost:14500\n
                                                                        \n
                                                                        In your browser you can access the dockered application at address:\n
                                                                        \n
                                                                        \ \ http://localhost:14500\n
                                                                        \n
                                                                        Further infos at https://xpra.org/trac/wiki/Clients/HTML5 
                                                                   ")
                                                                 @text(" Sample setup for VNC\n
                                                                        \n
                                                                        \ \ read Xenv < <(x11docker --xdummy  x11docker/lxde pcmanfm)\n
                                                                        \ \ echo \$Xenv\n
                                                                        \ \ export \$Xenv\n
                                                                        \ \ x11vnc -localhost -noshm \n
                                                                        \n
                                                                        In another terminal, start VNC viewer with \n
                                                                        \n
                                                                        \ \ vncviewer localhost:0 \n
                                                                        \n
                                                                        See \"man x11vnc\" for many details and further infos.\n
                                                                        x11vnc option \"-noshm\" disables shared memory (MIT-SHM). \n
                                                                        To allow shared memory, use insecure x11docker option --ipc.
                                                                        ")
                                                                        
                                                                 @fill(" Sample setup to access dockered GUI applications over ssh:\n
                                                                        \n
                                                                        \ \ read Xenv < <(x11docker --xdummy x11docker/lxde pcmanfm)\n
                                                                        \ \ echo \$Xenv\n
                                                                        \ \ export \$Xenv\n
                                                                        \ \ xhost +SI:localuser:\$USER\n
                                                                        \ \ xpra start ssh:127.0.0.1\$DISPLAY --use-display --start-via-proxy=no\n
                                                                        \n
                                                                        In another terminal, you can connect with:\n
                                                                        \n
                                                                        \ \ xpra attach ssh:127.0.0.1\$NEWDISPLAY  # NEWDISPLAY must be same as DISPLAY in \$Xenv
                                                                   ")
                                                                 @fill(" To allow access for rest of world, read https://xpra.org/trac/wiki/Clients/HTML5 and\n
                                                                        make sure to take care of security, opening firewall and router ports and such stuff.\n
                                                                        In this case, do not use a host window manager with option --wm, it can be risky and is needless!\n
                                                                        \n
                                                                        For security and authentication, read xpra manpage and \n
                                                                        http://xpra.org/trac/wiki/Encryption/SSL
                                                                   ") @close=" Close";
         
  xdependenciesbutton:dialog "Dependencies" -> xdependencies @text(" Other dependencies, some in image, too") xdependencies2 @close=" close";
    xdependencies:beside -> xdep_option xdep_host xdep_xrunning ;
      xdep_option -> xdep_option_title  
                     xdep_option_xpra         xdep_option_xephyr 
                     xdep_option_xpraxwayland xdep_option_westonxwayland
                     xdep_option_hostdisplay  xdep_option_xorg
                     xdep_option_nxagent
                     xdep_option_xwayland     xdep_option_xdummy xdep_option_xvfb
                     xdep_option_wayland      xdep_option_kwin
                     xdep_option_weston ;
        xdep_option_title ->          @text(" X server");
        xdep_option_xpra ->           @text(" --xpra");
        xdep_option_xephyr ->         @text(" --xephyr");
        xdep_option_xorg ->           @text(" --xorg");
        xdep_option_hostdisplay ->    @text(" --hostdisplay");
        xdep_option_xpraxwayland ->   @text(" --xpra-xwayland");
        xdep_option_westonxwayland -> @text(" --weston-xwayland");
        xdep_option_nxagent ->        @text(" --nxagent");
        xdep_option_xwayland ->       @text(" --xwayland");
        xdep_option_xdummy ->         @text(" --xdummy");
        xdep_option_xvfb ->           @text(" --xvfb");
        xdep_option_weston ->         @text(" --weston");
        xdep_option_kwin ->           @text(" --kwin, --kwin-xwayland ");
        xdep_option_wayland ->        @text(" --hostwayland");
      xdep_host -> xdep_host_title  
                   xdep_host_xpra         xdep_host_xephyr
                   xdep_host_xpraxwayland xdep_host_westonxwayland
                   xdep_host_hostdisplay  xdep_host_xorg
                   xdep_host_nxagent
                   xdep_host_xwayland     xdep_host_xdummy xdep_host_xvfb
                   xdep_host_wayland      xdep_host_kwin
                   xdep_host_weston ;
        xdep_host_title ->          @text(" Dependencies on host");
        xdep_host_xpra ->           @text(" xpra");
        xdep_host_xephyr ->         @text(" Xephyr");
        xdep_host_xorg:beside ->    @text(" - \ [ xerver-xorg-legacy ]") xdep_xorg_setupdialog;
        xdep_host_hostdisplay ->    @text(" -");
        xdep_host_xpraxwayland ->   @text(" Xwayland \ xpra \ [on X also: \ weston \ xdotool ]");
        xdep_host_westonxwayland -> @text(" Xwayland \ weston");
        xdep_host_nxagent ->        @text(" nxagent");
        xdep_host_xwayland ->       @text(" Xwayland");
        xdep_host_xdummy ->         @text(" (dummy video driver for Xorg)");
        xdep_host_xvfb ->           @text(" Xvfb");
        xdep_host_weston ->         @text(" weston");
        xdep_host_kwin ->           @text(" kwin Xwayland");
        xdep_host_wayland ->        @text(" -");
      xdep_xrunning -> xdep_xrun_title  
                       xdep_xrun_xpra         xdep_xrun_xephyr
                       xdep_xrun_xpraxwayland xdep_xrun_westonxwayland
                       xdep_xrun_hostdisplay  xdep_xrun_xorg
                       xdep_xrun_nxagent
                       xdep_xrun_xwayland     xdep_xrun_xdummy xdep_xrun_xvfb
                       xdep_xrun_wayland      xdep_xrun_kwin
                       xdep_xrun_weston ;
        xdep_xrun_title ->          @text(" Needs running X or Wayland on host");
        xdep_xrun_xpra ->           @text(" X \ (or Xwayland on Wayland)");
        xdep_xrun_xephyr ->         @text(" X \ (or Xwayland on Wayland)");
        xdep_xrun_xorg ->           @text(" -");
        xdep_xrun_hostdisplay ->    @text(" X \ (or Xwayland on Wayland)");
        xdep_xrun_xpraxwayland ->   @text(" X \ (or Xwayland on Wayland)");
        xdep_xrun_westonxwayland -> @text(" -");
        xdep_xrun_nxagent ->        @text(" X \ (or Xwayland on Wayland)");
        xdep_xrun_xwayland ->       @text(" Wayland");
        xdep_xrun_xdummy ->         @text(" -");
        xdep_xrun_xvfb ->           @text(" -");
        xdep_xrun_weston ->         @text(" -");
        xdep_xrun_kwin ->           @text(" -");
        xdep_xrun_wayland ->        @text(" Wayland");
    xdependencies2:beside -> xdep_options xdep_text ;
      xdep_options -> xdep_gpu      xdep_xclip      xdep_pulseaudio      xdep_dbus;
      xdep_text    -> xdep_gpu_text xdep_xclip_text xdep_pulseaudio_text xdep_dbus_text;
      xdep_xclip           -> @text("--clipboard") ;
      xdep_xclip_text      -> @text("Needs package xclip on host (except for options --xpra, --xpra-xwayland and --nxagent).") ; 
      xdep_pulseaudio      -> @text("--pulseaudio") ;
      xdep_pulseaudio_text -> @text("Needs package pulseaudio on host AND in image.") ;
      xdep_dbus            -> @text("--dbus, --dbus-system") ;
      xdep_dbus_text       -> @text("Needs package dbus in image.") ;
      xdep_systemd         -> @text("--systemd") ;
      xdep_systemd_text    -> @text("Needs systemd in image") ;
      xdep_gpu             -> @text("--gpu\n\n\n") ;
      xdep_gpu_text        -> @text("Needs OpenGL dependencies (mesa) to be installed in image. For debian images: mesa-utils mesa-utils-extra,\n
                                     CentOS and fedora images: glx-utils mesa-dri-drivers, Arch Linux images: mesa-demos\n
                                     Works best with open source drivers on host. For closed source drivers look at terminal output.");
    xdep_xorg_setupdialog:dialog "Setup" -> @text(" Option --xorg can be used out of the box on console tty1...tty6. \n
                                                   \n
                                                   To run a second Xorg server from within an already running X session, \n
                                                   you have to edit file /etc/X11/Xwrapper.conf and replace line:\n
                                                   \n
                                                   \ \ allowed_users=console \n
                                                   \n
                                                   with lines:\n
                                                   \n
                                                   \ \ allowed_users=anybody \n
                                                   \ \ needs_root_rights=yes \n
                                                   \n
                                                   On debian 9 and Ubuntu 16.04 you need to install package xserver-xorg-legacy.
                                                   ") @close=" close";

  help:dialog "Help" -> @text(
  " x11docker allows you to run GUI applications and desktop environments from inside of docker images. \n
    Its main purpose is to preserve container isolation while avoiding some X security leaks. \n
    Core concept is to run a segregated second X server and to reduce container privileges.\n
    \n
    Simplest use case: \n
    \ \ \ x11docker IMAGENAME [IMAGECOMMAND]\n
    \n
    Depending on chosen options, you can have high or low container isolation. \n
    Look at button [Security info] to see the differences. x11docker shows terminal messages if something is less secure.\n
    \n
    Automatically choosing an X server:\n
    If no X server option is chosen, x11docker looks for best match in dependencies to run a single application.\n
    If option --desktop is given, it looks for the best match to run a desktop environment.\n
    \n
    Single applications:\n
    With recommended option --xpra, the dockered applications will appear on your already running X display.\n
    You can also choose discouraged option --hostdisplay for this to have least overhead, but then you have quite \n
    bad container isolation, and some applications may fail. \n
    A faster startup than --xpra without drawbacks of --hostdisplay provides --nxagent.\n
    \n
    Desktop environments:\n
    For desktop environments in docker, --xephyr is recommended.\n
    \n
    GPU acceleration:\n
    With option --gpu you can get hardware acceleration for OpenGL graphics rendering. Single applications run best \n
    with --xpra-xwayland or --hostdisplay, desktop environments best with --weston-xwayland, --kwin-xwayland or --xorg.\n
    If GPU acceleration fails, check OpenGL dependencies in image. (Compare dialog button \"Dependencies\")\n
    If no X server option is specified, x11docker will choose the best possibility depending on installed dependencies.\n
    \n
    Wayland: \n
    If option --wayland is given, x11docker sets up a pure Wayland environment without X.\n
    You can specify your preferred Wayland compositor with --weston, --kwin or --hostwayland.\n
    QT5 applications often (always?) need option --dbus, GTK3 applications often fail with option --dbus.\n 
    \n
    Troubleshooting:\n
    Run in terminal to see some messages. Activate option --verbose to see full logfile output.\n
    If the automatically chosen password prompt does not fit your setup, choose another one with option --pw.\n
    Some applications may not work well with --hostdisplay. Choose another X server option.\n
    \n
    x11docker and x11docker-gui are published under MIT licence. \n
    Please report issues and get further infos at github: https://github.com/mviereck/x11docker\n
    Some example docker images can be found at https://hub.docker.com/u/x11docker
    ") helpbuttons;
  helpbuttons:beside -> MIT @close=" close" ;
    
    security_dialog:dialog " Security info " -> sec_info sec_degrading_title sec_degrading sec_developer sec_doesntmatter @close=" close";
      sec_info               -> @text(" Main intention of x11docker is to allow running GUI applications in docker on X11 or Wayland while preserving container isolation. \n\n
                                        Most important part is to avoid common X security leaks, making keylogging and remote controlling of host applications impossible. \n
                                        This is given for all provided X servers (and Wayland compositors) except option --hostdisplay (see below).\n
                                        Core concept is to run a segregated second X server with its own authentication cookies.\n\n
                                        Hardening container security:\n
                                        Default user in container is same as host user to avoid root running GUI applications.\n
                                        All default docker container capabilities like user switching, chroot and setuid/setgid are disabled.\n
                                        Used docker options for container security hardening: \"--cap-drop=ALL --security-opt=no-new-privileges\"\n\n
                                        Weaknesses / ToDo:\n
                                        If docker daemon runs with --selinux-enabled, SELinux restrictions are degraded with label container_runtime_t to allow access to X unix socket.\n
                                        User namespace remapping has limited support and is disabled for options --home and --homedir.\n\n
                                        x11docker shows warnings in terminal if chosen options degrade container isolation.
                                        ") ;
      sec_degrading_title    -> @text(" Most used options degrading container isolation:");
      sec_degrading:beside   -> sec_deg_opt sec_deg_text;
        sec_deg_opt          -> sec_hostdisplay_opt  sec_gpu_opt  sec_pulseaudio_opt  sec_init_opt  sec_capdefault_opt  sec_sudouser_opt;
        sec_deg_text         -> sec_hostdisplay_text sec_gpu_text sec_pulseaudio_text sec_init_text sec_capdefault_text sec_sudouser_text;
          sec_gpu_opt          -> @text(" --gpu \n\n\n\n\n");
          sec_gpu_text         -> @text(" Option --gpu allows hardware acceleration for dockered OpenGL applications. Access to GPU hardware can allow rootkits. \n
                                          Example rootkit: https://github.com/x0r1/jellyfish\n
                                          Although there is little known of real attacks, you should be aware of this. This affects X servers and Wayland compositors as well. \n
                                          Furthermore, container applications can grab video RAM content formerly drawn by host applications (palinopsia leak).\n\
                                          Attention: Enables insecure option --ipc and --trusted for --hostdisplay, therefore allowing keylogging and remote host control.");
          sec_hostdisplay_opt  -> @text(" --hostdisplay \n\n\n");
          sec_hostdisplay_text -> @text(" Quite bad container isolation, but least overhead of all X server options. Use with trusted images only.\n
                                          Instead of creating a new segregated X server to avoid X security leaks, your host X server is shared with container. \n
                                          x11docker avoids keylogging and other attacks using untrusted cookies, but do not rely on this. \n");
          sec_pulseaudio_opt   -> @text(" --pulseaudio \n --alsa\n");
          sec_pulseaudio_text  -> @text(" With sound enabled, container applications can catch your audio output and also can hear everything you say \n
                                          if your computer has microphones. With option --alsa, container applications have immediate access to sound hardware.");
          sec_init_opt         -> @text(" --systemd \n --runit \n --openrc");
          sec_init_text        -> @text(" Init system options --systemd, --openrc and --runit allow some container capabilities, but mostly identical to default docker settings. \n
                                          --systemd additionally shares access to /sys/fs/cgroup. \n
                                          --runit and --openrc add non-default capability SYS_BOOT.\n");
          sec_capdefault_opt   -> @text(" --cap-default ");
          sec_capdefault_text  -> @text(" Allows default container capabilities; disables container security hardening by x11docker.");
          sec_sudouser_opt     -> @text(" --sudouser ");
          sec_sudouser_text    -> @text(" Allows sudo with password \"x11docker\" in container. Allows many capabilities. Outbreaking applications have no limits. ");
          sec_developer        -> @text(" Some options in the \"Developer\" section degrade container isolation, especially those in part \"container capabilities\". Please install brain.exe");
          sec_doesntmatter     -> @text(" If you do not care about container isolation at all, get a quite fast setup with \"x11docker --hostdisplay --gpu IMAGENAME\" ");
                       
  MIT:dialog "MIT license" -> @text(
               " MIT License\n
                 \n
                 Copyright (c) 2015,2016,2017,2018 Martin Viereck\n
                 \n
                 Permission is hereby granted, free of charge, to any person obtaining a copy\n
                 of this software and associated documentation files (the \"Software\"), to deal\n
                 in the Software without restriction, including without limitation the rights\n
                 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n
                 copies of the Software, and to permit persons to whom the Software is\n
                 furnished to do so, subject to the following conditions:\n
                 \n
                 The above copyright notice and this permission notice shall be included in all\n
                 copies or substantial portions of the Software.\n
                 \n
                 THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n
                 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n
                 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n
                 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n
                 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n
                 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n
                 SOFTWARE.") @close="close";

x11docker_options -> choose_xserver sizefullscreen choose_options_normal choose_options_advanced choose_options_hostfolders develcollect imageorexe "\"" setcapsdialog dockeroptions "\" " "\""dockerimage "\"" ;
x11docker -> "'$X11docker_exe' " x11docker_options;

buttons :horizontal ->  run runxterm preview desktop_starter orphanedcheck help @dump("")="Cancel";
  old_run -> @fork(x11docker)=" Run";
  run -> @dump(x11docker)=" Run";
  preview -> @preview(x11docker,"monospace",900)="Preview command" ;
  desktop_starter -> @dump("xterm -e '\''","'$X11docker_exe' --starter ",x11docker_options,"'\''")="Create desktop starter";
  orphanedcheck -> @dump("xterm -hold -e '"'"'pkexec '$X11docker_exe' "," --cleanup '"'"'")="Clean up";
  runxterm -> @dump("xterm -hold -e '"'"'",x11docker,"'"'"'")="Run in xterm";
'

# remove double whitespaces
Kaptain_grammar="$(sed -e 's/  */ /g' <<< "$Kaptain_grammar")"

# check options
Verbose="--silent"
case "$1" in
  --icon)
    echo "x11docker-gui does no longer create an icon on demand." >&2
    exit 1
  ;;
  -v|--verbose) 
    kaptain --version
    Verbose="--verbose" 
    echo "x11docker-gui: created kaptain grammar:"
    printf "%s" "$Kaptain_grammar"
    echo ""
  ;;
esac

# check kaptain version

command -v kaptain >/dev/null && Hostkaptain="yes" || Hostkaptain="no"

[ "$Hostkaptain" = "yes" ] && kaptain --version 2>&1 | grep -q 'kaptain 0.72' && {
  # regard kde3-kaptain from openSUSE KDE:KDE3 repository
  # up to date from decades ago is 0.73
  warning " Your version 0.72 of kaptain is outdated.
  kaptain version 0.73 with important bugfixes is available at:
    https://github.com/mviereck/kaptain
  Output of 'kaptain --version':
$(kaptain --version)
  Fallback: Using image x11docker/kaptain instead"
  Hostkaptain="no"
}

# Run kaptain either from host or with x11docker/kaptain image
case $Hostkaptain in
  yes)
    [ "$Verbose" = "--verbose" ] && {
         X11docker_command="$(kaptain <<< "$Kaptain_grammar")" ||:
    } || X11docker_command="$(kaptain 2>/dev/null <<< "$Kaptain_grammar")"
  ;;
  no)
    warning "Did not find executeable 'kaptain'.
If your distribution does not provide package kaptain (>=0.73), look at
kaptain repository:   https://github.com/mviereck/kaptain
Fallback: Will try to use image x11docker/kaptain."
#    read -r X11docker_command < <(printf "%s" "$Kaptain_grammar" | bash $X11docker_exe --hostdisplay --size 980x720 --no-init --clipboard $Verbose --stdout --sharedir "$X11docker_icon" --env HOME="$CONTAINERUSERHOME" -- --volume="$CONTAINERUSERHOME":"$CONTAINERUSERHOME":ro x11docker/kaptain)
    read -r X11docker_command < <(bash $X11docker_exe --hostdisplay --size 980x720 --stdin --no-init --clipboard $Verbose --stdout --sharedir "$X11docker_icon" --env HOME="$CONTAINERUSERHOME" -- --volume="$CONTAINERUSERHOME":"$CONTAINERUSERHOME":ro x11docker/kaptain <<< "$Kaptain_grammar")
  ;;
esac

# run x11docker
echo $X11docker_command
eval $X11docker_command
